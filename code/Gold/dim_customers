%md
#INIT
import pyspark.sql.functions as F
from pyspark.sql.window import Window
%md
#BUSINESS TRANSFORMATION AND MODELING
%sql
SELECT 
  ci.Customer_id,
  ci.Customer_key,
  ci.Firstname,
  ci.Lastname,
  ci.Marital_status,
  CASE WHEN ci.Gender != 'n/a' THEN ci.Gender -- CRM is the Master Gender Info
      ELSE COALESCE(cu.Gender, 'n/a')
  END AS Gender,
  lo.Country,
  cu.BirthDate,
  ci.Create_date
FROM silver.crm_cust_info ci
LEFT JOIN silver.erp_cust_az12 cu 
ON ci.Customer_key = cu.CousomerID
LEFT JOIN silver.erp_loc_a101 lo 
ON ci.Customer_key = lo.CustomerID
%md
#WRITE IT TO GOLD TABLE
%sql
CREATE VIEW gold.dim_customers AS 
SELECT 
  ci.Customer_id,
  ci.Customer_key,
  ci.Firstname,
  ci.Lastname,
  ci.Marital_status,
  CASE WHEN ci.Gender != 'n/a' THEN ci.Gender -- CRM is the Master Gender Info
      ELSE COALESCE(cu.Gender, 'n/a')
  END AS Gender,
  lo.Country,
  cu.BirthDate,
  ci.Create_date
FROM silver.crm_cust_info ci
LEFT JOIN silver.erp_cust_az12 cu 
ON ci.Customer_key = cu.CousomerID
LEFT JOIN silver.erp_loc_a101 lo 
ON ci.Customer_key = lo.CustomerID
